{"changed":true,"filter":false,"title":"cached_api.js","tooltip":"/util/cached_api.js","value":"var db = require('./db.js');\n\nvar cached_api = function() {\n\n  var api = require('./api');\n  var cacheHit = 0;\n  var cacheMiss = 0;\n\n  db.collection('apicache').ensureIndex([['url', 1]], \n        true, function(err, replies){});\n  db.bind('apicache');\n\n  // get data from API call\n  var get = function(options, callback) {\n    var cached_callback = function(err, result) {\n      console.log('cached_api.cached_callback');\n      if (err) {\n        console.log('cached_api.cached_callback err:' + JSON.stringify(err));\n        return callback(err, result);\n      }\n      console.log('cached_api.cached_callback payload:' + result);\n      var d = new Date();\n      var jsondate = d.toJSON();\n      db.apicache.insert({\n        url: options,\n        payload: result,\n        retrieved: jsondate,\n      }, function(err) {\n        console.log('apicache insert - err: ' + err);\n        callback(err,result);\n      });\n    }\n    console.log('cached_api.get: ' + options);\n    \n    if (options === options.toString()) {\n      db.apicache.findOne({url: options}, function(err, cachedApi) {\n        if (err || !cachedApi) {\n          cacheMiss++;\n          console.log('apicache_log.get: CACHE MISS ' + cacheMiss);\n          console.log('apicache.findOne - error:' + err);\n          console.log('apicache.findOne - result:' + cachedApi);\n          api.get(options, cached_callback);\n        } else {\n          cacheHit++;\n          console.log('cached_api.get: CACHE HIT ' + cacheHit);\n          callback(null, cachedApi.payload);\n        }\n      }); \n    } else {\n      console.log('cached_api.get: CACHE BYPASS');\n      api.get(options, callback);\n    }\n  };\n\n\tvar post = function(options, callback) {\n    console.log('cached_api.post: ' + options);\n\t\tapi.post(options, callback);\n\t}\n\n\treturn {\n\t\tget: get,\n\t\tpost: post\n\t}\n\n}();\n\nmodule.exports = cached_api;\n","undoManager":{"mark":-1,"position":26,"stack":[[{"group":"doc","deltas":[{"start":{"row":13,"column":41},"end":{"row":14,"column":0},"action":"insert","lines":["",""]},{"start":{"row":14,"column":0},"end":{"row":14,"column":4},"action":"insert","lines":["    "]}]}],[{"group":"doc","deltas":[{"start":{"row":14,"column":4},"end":{"row":14,"column":5},"action":"insert","lines":["v"]}]}],[{"group":"doc","deltas":[{"start":{"row":14,"column":5},"end":{"row":14,"column":6},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":14,"column":6},"end":{"row":14,"column":7},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":14,"column":7},"end":{"row":14,"column":8},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":14,"column":8},"end":{"row":14,"column":9},"action":"insert","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":14,"column":9},"end":{"row":14,"column":10},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":14,"column":10},"end":{"row":14,"column":11},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":14,"column":11},"end":{"row":14,"column":12},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":14,"column":12},"end":{"row":14,"column":13},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":14,"column":13},"end":{"row":14,"column":14},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":14,"column":14},"end":{"row":14,"column":15},"action":"insert","lines":["="]}]}],[{"group":"doc","deltas":[{"start":{"row":14,"column":15},"end":{"row":14,"column":16},"action":"insert","lines":[" "]}]}],[{"group":"doc","deltas":[{"start":{"row":14,"column":16},"end":{"row":14,"column":17},"action":"insert","lines":["D"]}]}],[{"group":"doc","deltas":[{"start":{"row":14,"column":17},"end":{"row":14,"column":18},"action":"insert","lines":["a"]}]}],[{"group":"doc","deltas":[{"start":{"row":14,"column":18},"end":{"row":14,"column":19},"action":"insert","lines":["t"]}]}],[{"group":"doc","deltas":[{"start":{"row":14,"column":19},"end":{"row":14,"column":20},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":14,"column":20},"end":{"row":14,"column":21},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":14,"column":21},"end":{"row":14,"column":22},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":14,"column":22},"end":{"row":14,"column":23},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":14,"column":23},"end":{"row":14,"column":24},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":14,"column":23},"end":{"row":14,"column":24},"action":"remove","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":14,"column":23},"end":{"row":14,"column":24},"action":"insert","lines":["w"]}]}],[{"group":"doc","deltas":[{"start":{"row":14,"column":21},"end":{"row":14,"column":24},"action":"remove","lines":["now"]},{"start":{"row":14,"column":21},"end":{"row":14,"column":26},"action":"insert","lines":["now()"]}]}],[{"group":"doc","deltas":[{"start":{"row":14,"column":26},"end":{"row":14,"column":27},"action":"insert","lines":[";"]}]}],[{"group":"doc","deltas":[{"start":{"row":14,"column":0},"end":{"row":14,"column":27},"action":"remove","lines":["    var start = Date.now();"]}]}],[{"group":"doc","deltas":[{"start":{"row":13,"column":41},"end":{"row":14,"column":0},"action":"remove","lines":["",""]}]}]]},"ace":{"folds":[],"scrolltop":0,"scrollleft":0,"selection":{"start":{"row":13,"column":41},"end":{"row":13,"column":41},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"timestamp":1422009893507}