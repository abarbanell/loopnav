{"changed":true,"filter":false,"title":"users.js","tooltip":"/model/users.js","value":"\nvar db = require('../util/db');\ndb.bind('user');\ndb.user.ensureIndex([['userId', 1]], { unique: true }, function(err, replies){});\nvar loop_api = require('../util/loop_api');\nvar logger = require('../util/logger');\n\nvar user = function() {\n\n\tvar get = function(id, callback) {\n\t\tdb.user.findOne({userId: id}, callback);\n\t};\t\n\n\tvar getMultiWithPic = function(base, count, callback) {\n\t\tdb.user.find({ $and: [{ userId: { $gte: base }}, {status: 'ok-with-pic' }] }, null, {\n\t\t    limit: count,\n    \t\tsort: {\n      \t\t\t'userId': 1\n    \t\t}\n  \t\t}, function (err, resultCursor) {\n  \t\t\t//map cursor to array.\n  \t\t\tresultCursor.toArray(callback);\n  \t\t});\n\t}\n\t\n\t\n\tvar load = function(base, count, callback) {\n\t  loadOne(base, count, callback);\n\t};\n\t  \n\tvar loadOne = function(base, count, callback) {\n \t  logger.info('model.users.load(): base=' + base + ', count=' + count);\n\t  if (count <= 0) {\n\t\tlogger.info('model.users.loadOne - done');\n\t\treturn (callback()); //TODO do we need to pass err and result?\n\t  } else {\n\t  \tdb.user.findOne({userId: base}, function(err, res) {\n\t\t  if (err) {\n\t\t  \treturn callback(err, null);\n\t\t  }\n\t\t  if (res) {\n\t\t    logger.info('model.users.load(): found ' + base);\n\t\t    logger.info('model.users.load(): res = ' + JSON.stringify(res));\n\t\t    //TODO: check for picture and decide next step\n\t\t    if (res.status == 'ok-with-pic') {\n\t\t    \t\tcount--;\n\t\t    }\n\t\t    return loadOne(base+1, count, callback);\n\t\t  } else {\n\t\t    logger.info('model.users.load(): not found ' + base);\n\t\t    // here we try to get the data from api call\n\t\t    loop_api.main_info(base, function(err, result) {\n\t\t   \t  logger.info('model.users.loadOne: api result = ' + JSON.stringify(result)) \t\n    \t\t  var obj = {userId: base};\n    \t\t  if (err || !result) {\n    \t\t    // not found\n            obj.status = 'not-found';\n    \t\t  } else {\n        \t    if (result.hasOwnProperty('ProfilePicture') && result.ProfilePicture.toString().contains('Thumb_203_203')) {\n          \t\t  obj.status = 'ok-with-pic';\n        \t      obj.ProfilePicture = result.ProfilePicture;\n        \t      count--;\n      \t\t\t} else {\n        \t\t  obj.status = 'no-pic';\n    \t\t\t}\n    \t      }  \n    \t      logger.info('model.users.loadOne: status=' + obj.status + ' for id=' + obj.userId);\n    \t      db.user.save(obj, function(err, res) {\n    \t\t    if (err) {\n    \t\t\t  return callback(err, null);\n    \t\t\t} else {\n    \t\t\t  return loadOne(base+1, count, callback);\n    \t\t\t}\t\n    \t      });\n  \t\t\t});\n\t\t  }\n\t\t});\n\t  }\n\t}; \t\n\n\treturn {\n\t\tget: get,\n\t\tgetMultiWithPic: getMultiWithPic,\n\t\tload: load\n\t}\n}();\n\nmodule.exports = user;\n","undoManager":{"mark":-62,"position":100,"stack":[[{"group":"doc","deltas":[{"start":{"row":31,"column":14},"end":{"row":31,"column":15},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":33,"column":9},"end":{"row":33,"column":10},"action":"remove","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":33,"column":8},"end":{"row":33,"column":9},"action":"remove","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":33,"column":7},"end":{"row":33,"column":8},"action":"remove","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":33,"column":6},"end":{"row":33,"column":7},"action":"remove","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":33,"column":5},"end":{"row":33,"column":6},"action":"remove","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":33,"column":4},"end":{"row":33,"column":5},"action":"remove","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":33,"column":3},"end":{"row":33,"column":4},"action":"remove","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":33,"column":2},"end":{"row":33,"column":3},"action":"remove","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":33,"column":5},"end":{"row":33,"column":6},"action":"insert","lines":["g"]}]}],[{"group":"doc","deltas":[{"start":{"row":33,"column":6},"end":{"row":33,"column":7},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":33,"column":7},"end":{"row":33,"column":8},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":33,"column":8},"end":{"row":33,"column":9},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":33,"column":8},"end":{"row":33,"column":9},"action":"remove","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":33,"column":8},"end":{"row":33,"column":9},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":33,"column":9},"end":{"row":33,"column":10},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":33,"column":10},"end":{"row":33,"column":11},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":33,"column":11},"end":{"row":33,"column":12},"action":"insert","lines":["f"]}]}],[{"group":"doc","deltas":[{"start":{"row":33,"column":12},"end":{"row":33,"column":13},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":41,"column":13},"end":{"row":41,"column":14},"action":"remove","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":41,"column":12},"end":{"row":41,"column":13},"action":"remove","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":41,"column":11},"end":{"row":41,"column":12},"action":"remove","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":41,"column":10},"end":{"row":41,"column":11},"action":"remove","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":41,"column":9},"end":{"row":41,"column":10},"action":"remove","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":41,"column":8},"end":{"row":41,"column":9},"action":"remove","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":41,"column":7},"end":{"row":41,"column":8},"action":"remove","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":41,"column":6},"end":{"row":41,"column":7},"action":"remove","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":41,"column":9},"end":{"row":41,"column":10},"action":"insert","lines":["g"]}]}],[{"group":"doc","deltas":[{"start":{"row":41,"column":10},"end":{"row":41,"column":11},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":41,"column":11},"end":{"row":41,"column":12},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":41,"column":12},"end":{"row":41,"column":13},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":41,"column":13},"end":{"row":41,"column":14},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":41,"column":14},"end":{"row":41,"column":15},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":41,"column":15},"end":{"row":41,"column":16},"action":"insert","lines":["f"]}]}],[{"group":"doc","deltas":[{"start":{"row":41,"column":16},"end":{"row":41,"column":17},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":41,"column":17},"end":{"row":41,"column":18},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":41,"column":17},"end":{"row":41,"column":18},"action":"remove","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":42,"column":13},"end":{"row":42,"column":14},"action":"remove","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":42,"column":12},"end":{"row":42,"column":13},"action":"remove","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":42,"column":11},"end":{"row":42,"column":12},"action":"remove","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":42,"column":10},"end":{"row":42,"column":11},"action":"remove","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":42,"column":9},"end":{"row":42,"column":10},"action":"remove","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":42,"column":8},"end":{"row":42,"column":9},"action":"remove","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":42,"column":7},"end":{"row":42,"column":8},"action":"remove","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":42,"column":6},"end":{"row":42,"column":7},"action":"remove","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":42,"column":9},"end":{"row":42,"column":10},"action":"insert","lines":["g"]}]}],[{"group":"doc","deltas":[{"start":{"row":42,"column":10},"end":{"row":42,"column":11},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":42,"column":11},"end":{"row":42,"column":12},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":42,"column":12},"end":{"row":42,"column":13},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":42,"column":13},"end":{"row":42,"column":14},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":42,"column":14},"end":{"row":42,"column":15},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":42,"column":15},"end":{"row":42,"column":16},"action":"insert","lines":["f"]}]}],[{"group":"doc","deltas":[{"start":{"row":42,"column":16},"end":{"row":42,"column":17},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":49,"column":13},"end":{"row":49,"column":14},"action":"remove","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":49,"column":12},"end":{"row":49,"column":13},"action":"remove","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":49,"column":11},"end":{"row":49,"column":12},"action":"remove","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":49,"column":10},"end":{"row":49,"column":11},"action":"remove","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":49,"column":9},"end":{"row":49,"column":10},"action":"remove","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":49,"column":8},"end":{"row":49,"column":9},"action":"remove","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":49,"column":7},"end":{"row":49,"column":8},"action":"remove","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":49,"column":6},"end":{"row":49,"column":7},"action":"remove","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":49,"column":9},"end":{"row":49,"column":10},"action":"insert","lines":["g"]}]}],[{"group":"doc","deltas":[{"start":{"row":49,"column":10},"end":{"row":49,"column":11},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":49,"column":11},"end":{"row":49,"column":12},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":49,"column":12},"end":{"row":49,"column":13},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":49,"column":13},"end":{"row":49,"column":14},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":49,"column":14},"end":{"row":49,"column":15},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":49,"column":15},"end":{"row":49,"column":16},"action":"insert","lines":["f"]}]}],[{"group":"doc","deltas":[{"start":{"row":49,"column":16},"end":{"row":49,"column":17},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":52,"column":15},"end":{"row":52,"column":16},"action":"remove","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":52,"column":14},"end":{"row":52,"column":15},"action":"remove","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":52,"column":13},"end":{"row":52,"column":14},"action":"remove","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":52,"column":12},"end":{"row":52,"column":13},"action":"remove","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":52,"column":11},"end":{"row":52,"column":12},"action":"remove","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":52,"column":10},"end":{"row":52,"column":11},"action":"remove","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":52,"column":9},"end":{"row":52,"column":10},"action":"remove","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":52,"column":8},"end":{"row":52,"column":9},"action":"remove","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":52,"column":11},"end":{"row":52,"column":12},"action":"insert","lines":["g"]}]}],[{"group":"doc","deltas":[{"start":{"row":52,"column":12},"end":{"row":52,"column":13},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":52,"column":13},"end":{"row":52,"column":14},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":52,"column":14},"end":{"row":52,"column":15},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":52,"column":15},"end":{"row":52,"column":16},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":52,"column":16},"end":{"row":52,"column":17},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":52,"column":17},"end":{"row":52,"column":18},"action":"insert","lines":["f"]}]}],[{"group":"doc","deltas":[{"start":{"row":52,"column":18},"end":{"row":52,"column":19},"action":"insert","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":18},"end":{"row":66,"column":19},"action":"remove","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":17},"end":{"row":66,"column":18},"action":"remove","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":16},"end":{"row":66,"column":17},"action":"remove","lines":["l"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":15},"end":{"row":66,"column":16},"action":"remove","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":14},"end":{"row":66,"column":15},"action":"remove","lines":["s"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":13},"end":{"row":66,"column":14},"action":"remove","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":12},"end":{"row":66,"column":13},"action":"remove","lines":["o"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":11},"end":{"row":66,"column":12},"action":"remove","lines":["c"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":14},"end":{"row":66,"column":15},"action":"insert","lines":["g"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":15},"end":{"row":66,"column":16},"action":"insert","lines":["e"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":16},"end":{"row":66,"column":17},"action":"insert","lines":["r"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":17},"end":{"row":66,"column":18},"action":"insert","lines":["."]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":18},"end":{"row":66,"column":19},"action":"insert","lines":["i"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":19},"end":{"row":66,"column":20},"action":"insert","lines":["n"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":20},"end":{"row":66,"column":21},"action":"insert","lines":["f"]}]}],[{"group":"doc","deltas":[{"start":{"row":66,"column":21},"end":{"row":66,"column":22},"action":"insert","lines":["o"]}]}]]},"ace":{"folds":[],"scrolltop":874,"scrollleft":0,"selection":{"start":{"row":88,"column":0},"end":{"row":88,"column":0},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":{"row":53,"state":"start","mode":"ace/mode/javascript"}},"timestamp":1422215901418}